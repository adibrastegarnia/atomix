#!/bin/bash

readonly ROOT_WF_DIR=".github/workflows"

DIRS="$(find . -mindepth 2 -name '*.yml' -type f -not -path "./.git*/*")"

find $ROOT_WF_DIR -type f -name '*.yml' -delete

for file in $DIRS; do
  source=$(echo "$file" | sed 's/^.\///g')
  dest="$ROOT_WF_DIR/$(echo "$(dirname $(dirname $(dirname "$source")))" | sed 's/\//-/g')-$(basename "$source")"
  echo "$source -> $dest"
  echo "# Code generated by build-workflows script. DO NOT EDIT." >> $dest
  echo "# source: $source" >> $dest
  echo "" >> $dest
  cat "$source" >> "$dest"
done